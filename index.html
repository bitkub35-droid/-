<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตงมอเตอร์ - ระบบจัดการร้านรถมือสอง</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700&family=Kanit:wght@200;300;400;500;600&display=swap');
        
        :root {
            --tong-red: #dc2626;
            --tong-dark: #111827;
        }
        body { 
            font-family: 'Kanit', sans-serif; 
            background: linear-gradient(180deg, #1a0505 10%, #000000 100%);
            color: #1f2937;
            min-height: 100vh;
        }
        .heading-font { font-family: 'Chakra Petch', sans-serif; }
        .btn-red {
            background-color: var(--tong-red);
            color: white;
            transition: all 0.2s ease;
        }
        .btn-red:hover {
            background-color: #b91c1c;
            transform: translateY(-1px);
        }
        .header-sticky {
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .bike-card {
            transition: all 0.3s ease;
        }
        .bike-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .image-upload-box {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .image-upload-box:hover {
            border-color: var(--tong-red);
            background-color: #fef2f2;
        }
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            #receipt-template { display: block !important; width: 100%; position: absolute; top: 0; left: 0; }
            .print-border { border: 1px solid black !important; }
        }
        .sync-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="pb-10">

    <!-- Header & Dashboard -->
    <div class="no-print header-sticky">
        <header class="bg-gray-900 text-white border-b-4 border-red-600 shadow-xl">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-3 cursor-pointer" onclick="location.reload()">
                    <div class="bg-red-600 p-2 rounded transform -skew-x-12">
                        <i class="fas fa-motorcycle text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-black heading-font italic leading-none uppercase tracking-tighter">ตง มอเตอร์</h1>
                        <p class="text-[9px] text-red-500 font-bold uppercase tracking-widest">ตงมอเตอร์ รถจักรยานยนต์มือสองเกรดเอ</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div id="syncStatus" class="hidden mr-2">
                        <i class="fas fa-sync sync-spinner text-yellow-400 text-xs"></i>
                    </div>
                    <button onclick="toggleModal('settingsModal')" title="เชื่อมต่อ Google Sheets" class="bg-gray-800 text-gray-400 p-2 rounded-lg hover:text-white transition border border-gray-700">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button id="viewToggleBtn" onclick="toggleView()" class="bg-gray-800 text-yellow-400 font-bold px-3 py-2 rounded-xl text-xs flex items-center border border-yellow-400/30 hover:bg-gray-700 transition">
                        <i id="viewIcon" class="fas fa-table mr-2"></i>
                        <span id="viewLabel">สลับโหมดตาราง</span>
                    </button>
                    <button onclick="toggleModal('addModal')" class="btn-red px-5 py-2 rounded-xl font-bold text-sm shadow-lg flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i> เพิ่มรถเข้าใหม่
                    </button>
                </div>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="bg-white border-b shadow-sm"> 
            <div class="container mx-auto px-4 py-3">
                <div class="grid grid-cols-4 gap-4">
                    <div class="text-center md:text-left border-r border-gray-100 last:border-0">
                        <p class="text-[10px] text-gray-800 font-bold uppercase tracking-tighter">รถในสต็อก</p>
                        <h3 id="stat-total" class="text-2xl font-black heading-font tracking-tight">0</h3>
                    </div>
                    <div class="text-center md:text-left border-r border-gray-100 last:border-0">
                        <p class="text-[10px] text-gray-800 font-bold uppercase tracking-tighter">ขายแล้ว</p>
                        <h3 id="stat-sold" class="text-2xl font-black heading-font text-green-600 tracking-tight">0</h3>
                    </div>
                    <div class="text-center md:text-left border-r border-gray-100 last:border-0">
                        <p class="text-[10px] text-gray-800 font-bold uppercase tracking-tighter">รอเอกสาร</p>
                        <h3 id="stat-docs" class="text-2xl font-black heading-font text-yellow-600 tracking-tight">0</h3>
                    </div>
                    <div class="text-center md:text-left">
                        <p class="text-[10px] text-red-800 font-bold uppercase tracking-tighter">กำไรรวม</p>
                        <h3 id="stat-profit" class="text-2xl font-black heading-font tracking-tighter italic text-red-700">฿0</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 mt-6 no-print">
        <div class="flex flex-col md:flex-row gap-3 mb-6">
            <div class="relative flex-grow">
                <input type="text" id="searchInput" onkeyup="renderCurrentView()" placeholder="ค้นหารุ่นรถ, ทะเบียน..." 
                    class="w-full pl-11 pr-4 py-3 bg-white border rounded-2xl shadow-sm focus:ring-2 focus:ring-red-500 outline-none transition-all">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-300"></i>
            </div>
            <select id="filterStatus" onchange="renderCurrentView()" class="bg-white px-4 py-2 rounded-2xl shadow-sm font-bold text-gray-700 border outline-none cursor-pointer">
                <option value="all">สถานะ: ทั้งหมด</option>
                <option value="available">สถานะ: พร้อมขาย</option>
                <option value="sold">สถานะ: ขายแล้ว</option>
            </select>
        </div>

        <div id="gridView" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        <div id="tableView" class="hidden bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-900 text-white text-[10px] uppercase tracking-wider font-bold">
                        <tr>
                            <th class="p-4">รูป</th>
                            <th class="p-4">ยี่ห้อ/รุ่น</th>
                            <th class="p-4">ทะเบียน</th>
                            <th class="p-4 text-center">รับเข้า</th>
                            <th class="p-4 text-center">เอกสาร</th>
                            <th class="p-4 text-right">ทุน</th>
                            <th class="p-4 text-right">ขาย</th>
                            <th class="p-4 text-center">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal: Settings -->
    <div id="settingsModal" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden z-[110] flex items-center justify-center p-4 no-print">
        <div class="bg-white w-full max-w-md rounded-[2rem] shadow-2xl p-8 border-t-8 border-red-600">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold heading-font italic">เชื่อมต่อ Cloud Sync</h2>
                <button onclick="toggleModal('settingsModal')" class="text-gray-400 hover:text-black text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <input type="text" id="scriptUrl" placeholder="Google Apps Script URL" 
                    class="w-full p-4 bg-gray-50 border rounded-2xl outline-none text-sm focus:border-red-500">
                <button onclick="saveSettings()" class="w-full btn-red py-4 rounded-2xl font-bold uppercase shadow-lg">บันทึก</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add/Edit -->
    <div id="addModal" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden z-[100] flex items-center justify-center p-4 no-print">
        <div class="bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
            <div class="p-6 bg-gray-900 text-white flex justify-between items-center border-b-4 border-red-600">
                <h2 id="modalTitle" class="text-xl font-bold heading-font italic uppercase">ข้อมูลรถและเอกสาร</h2>
                <button onclick="toggleModal('addModal')" class="bg-gray-800 text-gray-400 hover:text-white w-10 h-10 rounded-full flex items-center justify-center transition">&times;</button>
            </div>
            <div class="p-8 overflow-y-auto">
                <form id="bikeForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <input type="hidden" id="editId">
                    <div class="md:col-span-2">
                        <div onclick="document.getElementById('fileInput').click()" class="image-upload-box rounded-3xl h-48 flex flex-col items-center justify-center overflow-hidden relative">
                            <img id="imagePreview" src="" class="hidden w-full h-full object-cover">
                            <div id="uploadPlaceholder" class="text-center">
                                <i class="fas fa-camera text-4xl text-gray-300 mb-2"></i>
                                <p class="text-[10px] text-gray-400 uppercase font-bold tracking-widest">อัปโหลดรูปภาพ</p>
                            </div>
                            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="previewImage(this)">
                            <textarea id="base64Store" class="hidden"></textarea>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-widest">ยี่ห้อ / รุ่น</label>
                        <input type="text" id="model" required class="w-full p-4 bg-gray-50 border rounded-2xl outline-none focus:border-red-500 font-bold">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-widest">ทะเบียน</label>
                        <input type="text" id="plate" class="w-full p-4 bg-gray-50 border rounded-2xl outline-none">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-widest">วันที่รับรถเข้า</label>
                        <input type="date" id="receiveDate" class="w-full p-4 bg-gray-50 border rounded-2xl outline-none">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-widest">ต้นทุน</label>
                        <input type="number" id="costPrice" required class="w-full p-4 bg-gray-50 border rounded-2xl text-red-600 font-black">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-widest">ราคาขาย</label>
                        <input type="number" id="salePrice" required class="w-full p-4 bg-gray-50 border rounded-2xl text-green-600 font-black">
                    </div>
                    
                    <div class="md:col-span-1">
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-widest">สถานะเอกสาร</label>
                        <select id="docStatus" class="w-full p-4 bg-blue-50 border border-blue-100 rounded-2xl outline-none text-blue-700 font-bold">
                            <option value="ชุดโอนครบ">ชุดโอนครบ (พร้อมโอน)</option>
                            <option value="รอเล่มทะเบียน">รอเล่มทะเบียน</option>
                            <option value="รอชุดโอน">รอชุดโอน</option>
                            <option value="แจ้งย้าย/โอนนอก">แจ้งย้าย/โอนนอก</option>
                            <option value="เอกสารไม่ครบ">เอกสารไม่ครบ (รอติดตาม)</option>
                            <option value="ไม่มีเล่ม">ไม่มีเล่ม (เฉพาะซาก/อะไหล่)</option>
                        </select>
                    </div>

                    <div class="md:col-span-1">
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-widest">สถานะการขาย</label>
                        <select id="status" onchange="toggleSaleFields()" class="w-full p-4 border rounded-2xl font-black text-red-600">
                            <option value="available">พร้อมขาย</option>
                            <option value="sold">ขายแล้ว</option>
                        </select>
                    </div>

                    <div id="soldFields" class="hidden md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-6 rounded-3xl border">
                        <input type="text" id="customerName" placeholder="ชื่อลูกค้า" class="w-full p-4 bg-white border rounded-2xl outline-none">
                        <input type="text" id="customerPhone" placeholder="เบอร์โทร" class="w-full p-4 bg-white border rounded-2xl outline-none">
                        <input type="date" id="sellDate" class="w-full p-4 bg-white border rounded-2xl outline-none">
                        <select id="paymentType" class="w-full p-4 bg-white border rounded-2xl outline-none font-bold">
                            <option value="เงินสด">เงินสด</option>
                            <option value="โอนเงิน">โอนเงิน</option>
                            <option value="ไฟแนนซ์">ไฟแนนซ์</option>
                        </select>
                        <div class="md:col-span-2">
                            <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">จำนวนมัดจำ</label>
                            <input type="number" id="depositAmount" placeholder="0" class="w-full p-4 bg-white border rounded-2xl outline-none text-blue-600 font-bold">
                        </div>
                    </div>
                    
                    <div class="md:col-span-2 pt-4">
                        <button type="submit" class="w-full btn-red py-5 rounded-2xl font-black text-xl heading-font shadow-xl uppercase">บันทึกข้อมูล</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Receipt Template -->
    <div id="receipt-template" class="hidden p-4 md:p-12 bg-white text-black min-h-screen">
        <div class="max-w-[850px] mx-auto bg-white p-8 border border-gray-200">
            <div class="flex justify-between items-start border-b-2 border-black pb-6 mb-8">
                <div>
                    <h1 class="text-4xl font-black heading-font italic text-red-600 tracking-tighter">ตง มอเตอร์</h1>
                    <p class="text-sm font-bold uppercase tracking-widest text-gray-500">ตงมอเตอร์ รถมือสองสภาพดี</p>
                    <div class="mt-4 text-xs space-y-1">
                        <p><i class="fas fa-location-dot mr-2"></i> เลขที่ 13 ถนนวิฑูรอุทิศ1 ตำบลสะเตง อำเภอเมืองยะลา ยะลา 95000</p>
                        <p><i class="fas fa-phone mr-2"></i> โทร: 081-959-9480 </p>
                        <p><i class="fas fa-globe mr-2"></i> facebook.com/ร้านซื้อ-ขายรถมอไซค์มือสองยะลา ตง มอเตอร์</p>
                    </div>
                </div>
                <div class="text-right">
                    <h2 class="text-2xl font-bold uppercase border-b-2 border-black mb-2 pb-1">ใบเสร็จรับเงิน / สัญญาจอง</h2>
                    <p class="text-sm">เลขที่: <span id="r-id" class="font-bold"></span></p>
                    <p class="text-sm">วันที่: <span id="r-date" class="font-bold"></span></p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-8 mb-8">
                <div class="space-y-3">
                    <h3 class="text-xs font-black uppercase tracking-widest bg-black text-white px-2 py-1 inline-block">ข้อมูลผู้ซื้อ / Customer</h3>
                    <div class="text-sm border-l-4 border-gray-200 pl-4 space-y-1">
                        <p>ชื่อ-นามสกุล: <span id="r-customer" class="font-bold border-b border-dotted border-gray-400 min-w-[150px] inline-block"></span></p>
                        <p>เบอร์โทรศัพท์: <span id="r-phone" class="font-bold border-b border-dotted border-gray-400 min-w-[150px] inline-block"></span></p>
                    </div>
                </div>
                <div class="space-y-3">
                    <h3 class="text-xs font-black uppercase tracking-widest bg-black text-white px-2 py-1 inline-block">รายละเอียดรถ / Vehicle</h3>
                    <div class="text-sm border-l-4 border-gray-200 pl-4 space-y-1">
                        <p>ยี่ห้อ/รุ่น: <span id="r-model" class="font-bold uppercase"></span></p>
                        <p>ทะเบียน: <span id="r-plate" class="font-bold text-red-600"></span></p>
                        <p>สถานะเอกสาร: <span id="r-docs" class="font-bold text-blue-700"></span></p>
                    </div>
                </div>
            </div>

            <table class="w-full mb-10 border-collapse">
                <thead>
                    <tr class="border-y-2 border-black bg-gray-50">
                        <th class="py-3 text-left pl-4 text-xs font-bold uppercase">รายการ / Description</th>
                        <th class="py-3 text-right pr-4 text-xs font-bold uppercase">จำนวนเงิน (บาท) / Amount</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    <tr>
                        <td class="py-4 pl-4 text-sm font-medium">ราคารถจักรยานยนต์รวมสุทธิ (Net Price)</td>
                        <td class="py-4 pr-4 text-right font-bold text-lg">฿<span id="r-price"></span></td>
                    </tr>
                    <tr id="r-deposit-row" class="text-blue-600">
                        <td class="py-4 pl-4 text-sm font-medium">หัก: เงินมัดจำ / เงินจอง (Deposit)</td>
                        <td class="py-4 pr-4 text-right font-bold">- ฿<span id="r-deposit"></span></td>
                    </tr>
                    <tr class="bg-gray-900 text-white">
                        <td class="py-4 pl-4 text-sm font-black uppercase">คงเหลือที่ต้องชำระ (Balance Due)</td>
                        <td class="py-4 pr-4 text-right font-black text-2xl">฿<span id="r-balance"></span></td>
                    </tr>
                </tbody>
            </table>

            <div class="grid grid-cols-2 gap-10 mb-12">
                <div class="text-[10px] text-gray-500 italic space-y-2">
                    <p>* ข้าพเจ้าได้รับทราบและตกลงซื้อรถจักรยานยนต์คันดังกล่าวในสภาพปัจจุบัน</p>
                    <p>* กรณีการจอง หากผู้ซื้อไม่มาดำเนินการภายใน 7 วัน ทางร้านขอสงวนสิทธิ์ในการยึดเงินมัดจำ</p>
                    <p>* การชำระเงินผ่าน: <span id="r-payment" class="font-bold text-black uppercase"></span></p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center pt-8 border-t border-black">
                        <p class="text-[10px] font-bold uppercase">ลงชื่อผู้ซื้อ</p>
                    </div>
                    <div class="text-center pt-8 border-t border-black">
                        <p class="text-[10px] font-bold uppercase">ลงชื่อผู้รับเงิน</p>
                    </div>
                </div>
            </div>
            
            <div class="text-center text-[10px] font-bold text-gray-400 uppercase tracking-[0.5em]">
                Thank you for choosing Tong Motor
            </div>
        </div>

        <div class="flex justify-center gap-4 mt-12 no-print">
            <button onclick="window.print()" class="bg-black text-white px-8 py-3 rounded-full font-bold shadow-lg flex items-center">
                <i class="fas fa-print mr-2"></i> พิมพ์ใบเสร็จ
            </button>
            <button onclick="location.reload()" class="bg-gray-200 text-gray-700 px-8 py-3 rounded-full font-bold hover:bg-gray-300">
                <i class="fas fa-arrow-left mr-2"></i> ย้อนกลับ
            </button>
        </div>
    </div>

    <script>
        const DB_KEY = 'tong_motor_v4';
        const SETTINGS_KEY = 'tong_motor_settings';
        
        let inventory = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        let settings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || { scriptUrl: '' };
        let currentMode = 'grid';

        function save() {
            localStorage.setItem(DB_KEY, JSON.stringify(inventory));
            updateStats();
            renderCurrentView();
            syncToCloud();
        }

        async function syncToCloud() {
            if (!settings.scriptUrl) return;
            document.getElementById('syncStatus').classList.remove('hidden');
            try {
                await fetch(settings.scriptUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(inventory.map(i => ({...i, img: ''}))) });
            } catch (e) {} finally { setTimeout(() => document.getElementById('syncStatus').classList.add('hidden'), 800); }
        }

        function saveSettings() {
            settings.scriptUrl = document.getElementById('scriptUrl').value;
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            toggleModal('settingsModal');
        }

        function previewImage(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreview').classList.remove('hidden');
                    document.getElementById('uploadPlaceholder').classList.add('hidden');
                    document.getElementById('base64Store').value = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function toggleModal(id) {
            const modal = document.getElementById(id);
            modal.classList.toggle('hidden');
            if(id === 'addModal' && modal.classList.contains('hidden')) {
                document.getElementById('bikeForm').reset();
                document.getElementById('editId').value = '';
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('uploadPlaceholder').classList.remove('hidden');
                document.getElementById('base64Store').value = '';
                toggleSaleFields();
            }
        }

        function toggleSaleFields() {
            const isSold = document.getElementById('status').value === 'sold';
            document.getElementById('soldFields').classList.toggle('hidden', !isSold);
        }

        document.getElementById('bikeForm').onsubmit = function(e) {
            e.preventDefault();
            const editId = document.getElementById('editId').value;
            
            const data = {
                id: editId !== '' ? editId : 'TM-' + Date.now().toString().slice(-6),
                model: document.getElementById('model').value,
                plate: document.getElementById('plate').value,
                receiveDate: document.getElementById('receiveDate').value,
                costPrice: parseFloat(document.getElementById('costPrice').value) || 0,
                salePrice: parseFloat(document.getElementById('salePrice').value) || 0,
                docStatus: document.getElementById('docStatus').value,
                status: document.getElementById('status').value,
                img: document.getElementById('base64Store').value || 'https://images.unsplash.com/photo-1558981403-c5f91cbba527?w=400',
                customerName: document.getElementById('customerName').value,
                customerPhone: document.getElementById('customerPhone').value,
                sellDate: document.getElementById('sellDate').value,
                paymentType: document.getElementById('paymentType').value,
                depositAmount: parseFloat(document.getElementById('depositAmount').value || 0)
            };

            if(editId !== '') {
                const index = inventory.findIndex(b => b.id === editId);
                if(index !== -1) {
                    if(!document.getElementById('base64Store').value && inventory[index].img) {
                        data.img = inventory[index].img;
                    }
                    inventory[index] = data;
                }
            } else {
                inventory.unshift(data);
            }
            
            save();
            toggleModal('addModal');
        };

        function editBikeById(id) {
            const b = inventory.find(item => item.id === id);
            if(!b) return;

            document.getElementById('editId').value = b.id;
            document.getElementById('model').value = b.model;
            document.getElementById('plate').value = b.plate;
            document.getElementById('receiveDate').value = b.receiveDate || '';
            document.getElementById('costPrice').value = b.costPrice;
            document.getElementById('salePrice').value = b.salePrice;
            document.getElementById('docStatus').value = b.docStatus;
            document.getElementById('status').value = b.status;
            
            if(b.img) {
                document.getElementById('imagePreview').src = b.img;
                document.getElementById('imagePreview').classList.remove('hidden');
                document.getElementById('uploadPlaceholder').classList.add('hidden');
                document.getElementById('base64Store').value = b.img;
            }

            document.getElementById('customerName').value = b.customerName || '';
            document.getElementById('customerPhone').value = b.customerPhone || '';
            document.getElementById('sellDate').value = b.sellDate || '';
            document.getElementById('paymentType').value = b.paymentType || 'เงินสด';
            document.getElementById('depositAmount').value = b.depositAmount || 0;
            
            toggleModal('addModal');
            toggleSaleFields();
        }

        function deleteBikeById(id) { 
            if(confirm('ยืนยันการลบข้อมูลคันนี้?')) { 
                inventory = inventory.filter(b => b.id !== id);
                save(); 
            } 
        }

        function showReceiptById(id) {
            const b = inventory.find(item => item.id === id);
            if(!b) return;

            const today = b.sellDate ? new Date(b.sellDate).toLocaleDateString('th-TH') : new Date().toLocaleDateString('th-TH');

            document.getElementById('r-id').innerText = b.id;
            document.getElementById('r-date').innerText = today;
            document.getElementById('r-customer').innerText = b.customerName || '-';
            document.getElementById('r-phone').innerText = b.customerPhone || '-';
            document.getElementById('r-model').innerText = b.model;
            document.getElementById('r-plate').innerText = b.plate;
            document.getElementById('r-docs').innerText = b.docStatus;
            document.getElementById('r-payment').innerText = b.paymentType;
            
            const price = b.salePrice || 0;
            const deposit = b.depositAmount || 0;
            const balance = price - deposit;

            document.getElementById('r-price').innerText = price.toLocaleString();
            
            const depositRow = document.getElementById('r-deposit-row');
            if(deposit > 0) {
                depositRow.classList.remove('hidden');
                document.getElementById('r-deposit').innerText = deposit.toLocaleString();
            } else {
                depositRow.classList.add('hidden');
            }
            
            document.getElementById('r-balance').innerText = balance.toLocaleString();

            document.querySelector('main').classList.add('hidden');
            document.querySelector('.header-sticky').classList.add('hidden');
            document.getElementById('receipt-template').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function toggleView() {
            currentMode = currentMode === 'grid' ? 'table' : 'grid';
            renderCurrentView();
        }

        function updateStats() {
            const avail = inventory.filter(b => b.status === 'available').length;
            const sold = inventory.filter(b => b.status === 'sold').length;
            const docs = inventory.filter(b => b.docStatus !== 'ชุดโอนครบ').length;
            const profit = inventory.reduce((acc, b) => b.status === 'sold' ? acc + (b.salePrice - b.costPrice) : acc, 0);
            
            document.getElementById('stat-total').innerText = avail;
            document.getElementById('stat-sold').innerText = sold;
            document.getElementById('stat-docs').innerText = docs;
            document.getElementById('stat-profit').innerText = "฿" + profit.toLocaleString();
        }

        function getDocColor(status) {
            if(status === 'ชุดโอนครบ') return 'bg-green-100 text-green-700';
            if(status === 'เอกสารไม่ครบ' || status === 'ไม่มีเล่ม') return 'bg-red-100 text-red-700';
            return 'bg-blue-100 text-blue-700';
        }

        function renderCurrentView() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filter = document.getElementById('filterStatus').value;
            const filtered = inventory.filter(b => 
                (b.model.toLowerCase().includes(search) || b.plate.toLowerCase().includes(search)) && 
                (filter === 'all' || b.status === filter)
            );

            if(currentMode === 'grid') {
                document.getElementById('gridView').classList.remove('hidden');
                document.getElementById('tableView').classList.add('hidden');
                document.getElementById('gridView').innerHTML = filtered.map((b) => `
                    <div class="bg-white rounded-[2rem] overflow-hidden shadow-sm border bike-card flex flex-col h-full">
                        <div class="h-40 relative">
                            <img src="${b.img}" class="w-full h-full object-cover">
                            
                            <!-- ป้ายสถานะบนรูป (ซ้าย: เอกสาร, ขวา: สถานะขาย) -->
                            <div class="absolute top-2 left-2 flex gap-1">
                                <span class="text-[8px] font-bold px-2 py-1 rounded-full shadow-sm ${getDocColor(b.docStatus)} uppercase tracking-tighter">${b.docStatus}</span>
                            </div>
                            
                            <div class="absolute top-2 right-2">
                                ${b.status === 'sold' 
                                    ? `<span class="bg-red-600 text-white text-[9px] font-black px-3 py-1 rounded-full shadow-lg uppercase italic border border-white/20">ขายแล้ว</span>`
                                    : `<span class="bg-green-500 text-white text-[9px] font-black px-3 py-1 rounded-full shadow-lg uppercase italic border border-white/20">ยังอยู่</span>`
                                }
                            </div>
                        </div>
                        <div class="p-5 flex-grow">
                            <h3 class="font-black text-sm uppercase italic truncate">${b.model}</h3>
                            <p class="text-[10px] text-red-600 font-bold mb-3">${b.plate || '-'}</p>
                            <p class="text-2xl font-black italic">฿${b.salePrice.toLocaleString()}</p>
                        </div>
                        <div class="p-3 grid grid-cols-2 gap-2 border-t bg-gray-50">
                            <button onclick="editBikeById('${b.id}')" class="bg-white border text-[9px] font-bold py-2 rounded-xl hover:bg-gray-100 transition">แก้ไข</button>
                            ${b.status === 'sold' ? 
                                `<button onclick="showReceiptById('${b.id}')" class="bg-black text-white text-[9px] font-bold py-2 rounded-xl hover:bg-gray-800 transition">ใบเสร็จ</button>` : 
                                `<button onclick="deleteBikeById('${b.id}')" class="text-red-300 text-[9px] hover:text-red-500 transition"><i class="fas fa-trash"></i></button>`
                            }
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('gridView').classList.add('hidden');
                document.getElementById('tableView').classList.remove('hidden');
                document.getElementById('tableBody').innerHTML = filtered.map((b) => `
                    <tr class="hover:bg-gray-50 border-b text-[11px]">
                        <td class="p-3"><img src="${b.img}" class="w-10 h-7 rounded object-cover shadow-sm"></td>
                        <td class="p-3 font-bold uppercase">
                            ${b.model}
                            <span class="ml-1 text-[8px] uppercase ${b.status === 'sold' ? 'text-red-600' : 'text-green-600'}">
                                (${b.status === 'sold' ? 'ขายแล้ว' : 'ยังอยู่'})
                            </span>
                        </td>
                        <td class="p-3 text-red-600 font-bold">${b.plate || '-'}</td>
                        <td class="p-3 text-center text-gray-400 font-bold">${b.receiveDate || '-'}</td>
                        <td class="p-3 text-center"><span class="px-2 py-0.5 rounded-full text-[9px] font-bold ${getDocColor(b.docStatus)}">${b.docStatus}</span></td>
                        <td class="p-3 text-right text-red-400 font-bold">฿${b.costPrice.toLocaleString()}</td>
                        <td class="p-3 text-right text-green-600 font-bold">฿${b.salePrice.toLocaleString()}</td>
                        <td class="p-3 text-center">
                            <div class="flex justify-center gap-3">
                                <button onclick="editBikeById('${b.id}')" title="แก้ไข"><i class="fas fa-edit text-blue-500"></i></button>
                                ${b.status === 'sold' ? `<button onclick="showReceiptById('${b.id}')" title="ใบเสร็จ"><i class="fas fa-file-invoice text-green-600"></i></button>` : ''}
                                <button onclick="deleteBikeById('${b.id}')" title="ลบ"><i class="fas fa-trash text-red-200 hover:text-red-500"></i></button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
        }

        window.onload = () => { 
            updateStats(); 
            renderCurrentView(); 
        };
    </script>
</body>
</html>
